machine:
  node:
    version: 6.10.2
  environment:
    AWS_REGION: us-east-1

  services:
    - docker

dependencies:
  pre:
    - sudo apt-get install libyaml-dev libpython2.7-dev
    - sudo pip install 'awsebcli==3.7.4' --force-reinstall
  override:
    - npm install
  post:
    - npm install -g envsub

deployment:
  development:
    branch: develop
    commands:
      - docker build --build-arg BUILD_ENV=dev -f deploy/Dockerfile -t $DEV_AWS_ACCOUNT_ID.dkr.ecs.$AWS_REGION.amazonaws.com/community-app:$CIRCLE_SHA1 .
      - ./deploy.sh DEV
      # - ./deploy/eb_deploy.sh community-app DEV $CIRCLE_BUILD_NUM topcoder-dev-vpc-nat


  production:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: topcoder-platform
    commands:
      - ./deploy/eb_deploy.sh community-app PROD $CIRCLE_BUILD_NUM topcoder-prod-nat

general:
  artifacts:
    - ./__coverage__
